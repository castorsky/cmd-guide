
.. _csp-utilities:

Утилиты для массовых операций с КЭП
=======================================


Системные требования
---------------------------------------

Скрипты, перечисленные в этом разделе, написаны на Windows PowerShell.

**Windows PowerShell** — расширяемое средство автоматизации от Microsoft, состоящее из оболочки с интерфейсом командной строки и сопутствующего языка сценариев.
Windows PowerShell 2.0 был выпущен в составе Windows 7, Windows 8 и Windows Server 2008 R2, а также Windows Server 2012 R2, как неотъемлемый компонент системы.
Кроме того, вторая версия доступна и для других систем, таких, как Windows XP SP3, Windows Server 2003 SP2, Windows Vista SP1, Windows Vista SP2, Windows Server 2008 и Windows Server 2012.

.. note:: Это означает, что только в Windows 7 и выше, есть встроенные средства для работы скриптов. В других системах нужно установить PowerShell отдельно (`Скачать <https://technet.microsoft.com/ru-ru/scriptcenter/dd742419.aspx>`_).



Также необходимо наличие установленной КриптоПро.


Запуск скриптов
-------------------------------------------------

Выполнять скрипты рекомендуется через среду разработки **Windows PowerShell ISE**. Чтобы не менять настройки безопасности на компьютерах абонентов:

1. Откройте скрипт в **Windows PowerShell ISE**;
2. Выделите код скрипта, нажмите ``F8`` и скрипт будет выполнен.


.. figure:: img/pw-ise.png
       :width: 500 px
       :align: center
       :alt:  

Если в процессе выполнения скрипта возникли ошибки или его не удалось запустить, смотрите раздел `Решение проблем`_.

Утилиты export_keys.ps1 и import_keys.ps1
-------------------------------------------------

* `Загрузить скрипты <https://github.com/itexperience/csp-utilities/archive/master.zip>`_

Две утилиты, используеющиеся совместно.

``export_keys.ps1``:

- автоматически определяет разрядность системы;
- автоматически определяет SID пользователя;
- экспортирует ветку в папку со скриптом.

``import_keys.ps1``:

- автоматически определяет разрядность системы;
- автоматически определяет SID пользователя;
- изменяет ветку реестра в экспортированном файле;
- импортирует файл с контейнерами;
- автоматически устанавливает сертификаты, перенесенных контейнеров.

.. note:: Утилиты целесообразно использовать в случае, когда требуется перенести большое количество контейнеров из реестра одного компьютера, в реестр другого.

Алгоритм работы 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Перенесети папку с утилитами на *первый* компьютер абонента, с которого надо скопировать контейнеры;
2. Запустите скрипт ``export_keys.ps1`` и дождитесь его успешного выполнения. При этом в папке со скриптами появится экспортированная ветка реестра;
3. Перенесите папку со скрипом и экспортированным файлом на *второй* компьютер;
4. Запустите скрипт ``import_keys.ps1`` и дождитесь его успешного выполнения;
5. Просмотрите вывод скрипта, на наличе проблем и проверьте вход в сервисы СКБ Контур.

.. note:: При использовании скриптов не требуется устанавливать сертификаты через КриптоПро. Однако, вы можете проверить через КриптоПро успешное выполнение сценариев.

.. attention:: Скрипт ``export_keys.ps1`` сохраняет ветку в файле ``ps_keys.reg`` на рабочем столе. Скрипт ``import_keys.ps1`` подхватывает файл ``ps_keys.reg`` также
 с рабочего стола и резудьтат обработки сохраняет в файле ``ps_keys_out.reg``.
 
 Файл ``ps_keys.reg`` не будет подхвачен скриптом ``import_keys.ps1`` из других папок.

Вывод скриптов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Скрипты подробно комментируют процесс своего выполнения, поэтому внимательно смотрите то, что они выводят в командной строке.

Пример успешного вывода ``export_keys.ps1``::

	Имя текущего пользователя: KONTUR\mazhartsev
	SID текущего пользователя: S-1-5-21-1231152155-1323711836-1525454979-65365
	Разрядность ПК: 64
	Путь к ветке реестра: HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Crypto Pro\Settings\USERS\S-1-5-21-1231152155-1323711836-1525454979-65365\Keys

	Файл экспортирован в: C:\Users\mazhartsev\Desktop\ps_keys.reg
	Для продолжения нажмите клавишу ВВОД...

Пример успешного вывода ``import_keys.ps1``::

	Имя текущего пользователя: KONTUR\mazhartsev
	SID текущего пользователя: S-1-5-21-1231152155-1323711836-1525454979-65365
	Разрядность ПК: 64
	Путь к ветке реестра: HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Crypto Pro\Settings\USERS\S-1-5-21-1231152155-1323711836-1525454979-65365
	Файл реестра для импорта: C:\Users\mazhartsev\Desktop\ps_keys_out.reg
	
	Exchange key found.

	Show user cert property
	Property # 2 found->KEY PROV INFO PROP ID.
	The current key container is: REGISTRY\\86425052@test2
	The provider name is: Crypto-Pro GOST R 34.10-2001 Cryptographic Service Provider
	Exchange key installed successfully.
	No signature key found.
	Total: SYS: 0,047 sec USR: 0,031 sec UTC: 0,094 sec
	[ErrorCode: 0x00000000]
	Exchange key found.

	Show user cert property
	Property # 2 found->KEY PROV INFO PROP ID.
	The current key container is: REGISTRY\\86425052@test3
	The provider name is: Crypto-Pro GOST R 34.10-2001 Cryptographic Service Provider
	Exchange key installed successfully.
	No signature key found.
	Total: SYS: 0,047 sec USR: 0,047 sec UTC: 0,095 sec
	[ErrorCode: 0x00000000]
	Для продолжения нажмите клавишу ВВОД...: 


Утилита cert-install.ps1
--------------------------------------------------

* `Загрузить утилиту <https://github.com/itexperience/csp-utilities/archive/master.zip>`_

``cert-install.ps1`` -- утилита для массовой установки сертификатов.

Позволяет массово устанавливать сертификаты с носителей. При необходимости можно установить сертификаты только с определенного носителя.

Алгоритм работы 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

После запуска скрипта появится меню выбора действий::

	Выберите вариант действий:
	   1 - Установить сертификаты со всех носителей;
	   2 - Установить сертификаты только с Флешки;
	   3 - Установить сертификаты только с Рутокена;
	   4 - Установить сертификаты только из Реестра;
	   5 - Выход.
	Выбор: 

В зависимости от выбора будет выполнена соответствующая операция.

Решение проблем
--------------------------------------------------

Windows блокирует запуск скрипта
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Система "безопасности" Windows может заблокировать выполнение скриптов. В такой ситуации требуется принудительно разрешить их выполнение.

Если при попытке выполнить сценарий появляется сообщение *Не удается загрузить файл <путь к вашему файлу>, так как выполнение скриптов запрещено для данной системы. 
Введите "get-help about_signing" для получения дополнительных сведений*, достаточно подтвердить свое согласие введя ``Y``. 

.. figure:: img/run-the-scrip-PowerShell-2.jpg
       :width: 500 px
       :align: center
       :alt:  

Также можно воспользоваться средой разработки Windows PowerShell ISE. Подробнее смотрите:

* `Создание и выполнение скриптов <https://technet.microsoft.com/ru-ru/library/dd819451.aspx>`_
* `Использование среды Windows PowerShell ISE <https://technet.microsoft.com/ru-ru/library/dd819474.aspx>`_



